{% extends 'base.html' %}

{% load static %}

{% block content %}

<h1>Payment</h1>

<form id="payment-form" class="mt-3">
  <div id="payment-element"></div>

  <input type="submit" value="Submit" class="btn btn-primary mt-3">

  <div id="payment-message"></div>
</form>

{% endblock %}

{% block scripts %}

<script src="https://js.stripe.com/v3/"></script>

{{ stripe_public_key|json_script:"stripe_public_key" }}
{{ stripe_client_secret|json_script:"stripe_client_secret" }}
{{ return_url|json_script:"return_url" }}

<script>
  const stripePublicKey = $('#stripe_public_key').text().slice(1, -1);
  const stripeClientSecret = $('#stripe_client_secret').text().slice(1, -1);
  const returnUrl = $('#return_url').text().slice(1, -1);
  const stripe = Stripe(stripePublicKey);
  const elements = stripe.elements({ clientSecret: stripeClientSecret });
  const paymentElement = elements.create('payment');
  paymentElement.mount('#payment-element');

  $(function () {
    $('#payment-form').on('submit', async function (event) {
      event.preventDefault();

      setLoading(true);

      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: returnUrl,
        },
      });

      if (error.type === 'card_error' || error.type === 'validation_error') {
        showMessage(error.message);
      } else {
        showMessage("An unexpected error occurred");
      }

      setLoading(false);
    });

    checkStatus();
  });

  async function checkStatus() {
    const clientSecret = new URLSearchParams(window.location.search).get('payment_intent_client_secret');

    if (!clientSecret)
      return;

    const { paymentIntent } = await stripe.retrievePaymentIntent(clientSecret);

    switch (paymentIntent.status) {
      case 'succeeded':
        showMessage('Payment succeeded!');
        break;

      case 'processing':
        showMessage('Your payment is processing');
        break;

      case 'requires_payment_method':
        showMessage('Your payment was not successful, please try again');
        break;

      default:
        showMessage('Something went wrong');
        break;
    }
  }

  function showMessage(message) {
    $('#payment-message').text(message);
  }

  function setLoading(isLoading) {
    $('#payment-form input:submit').prop('disabled', isLoading);
  }
</script>

{% endblock %}